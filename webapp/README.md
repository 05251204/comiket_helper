# ComiPath - Comiket TSP Web App

## 概要
コミックマーケット（コミケ）でのサークル巡回を効率化するためのWebアプリケーションです。
Googleスプレッドシートで管理された「行きたいサークルリスト」を読み込み、現在地から最も近いサークルを提示します（TSP: 巡回セールスマン問題の簡易版）。
スマホでの片手操作・一覧性を最優先に設計されています。

## 特徴
- **最短経路提案**: 現在地を入力すると、次に行くべき最も近いサークルを表示。
- **地図表示**: 次の目的地の周辺地図をピンポイントで表示。ピンチイン・アウトでのズームが可能。
- **オフライン対応**: 通信が不安定な会場内でも、キャッシュを利用して動作。購入・保留の記録はオフラインで行い、通信復帰時に自動同期。
- **ギャラリーモード**: エリアごとのサークルお品書きを一覧表示し、そこから購入チェックが可能。

## 技術スタック
- **Frontend**: HTML5, CSS3, JavaScript (ES Modules)
- **Backend**: Google Apps Script (GAS)
- **Database**: Google Sheets

## セットアップと使い方

### 1. Googleスプレッドシートの準備
1. 新規スプレッドシートを作成します。
2. 以下のヘッダーを持つシートを作成します（シート名は任意ですが、アプリ側で指定可能です）。
   - `space`: スペース番号 (例: 東A23a, 西12b) **必須**
   - `priority`: 優先度 (数値が高いほど優先)
   - `soldout`: 完売フラグ (TRUE/FALSE)
   - `account`: Twitter等のURL
   - `tweet`: お品書き画像のURL

### 2. GAS (Google Apps Script) のデプロイ
1. スプレッドシートの「拡張機能」>「Apps Script」を開きます。
2. `apps_script_code.js` の内容をコピーして貼り付けます。
3. 「デプロイ」>「新しいデプロイ」を選択。
4. 種類: 「ウェブアプリ」
5. アクセスできるユーザー: 「全員」
6. 発行されたURLをコピーします。

### 3. アプリの起動
1. `index.html` をWebサーバー（GitHub Pages等）にホストするか、ローカルで開きます。
2. アプリの設定ボタン（歯車アイコン）を押し、GASのURLを入力して更新します。
3. 「シート一覧を取得」し、対象のシートにチェックを入れます。
4. データが読み込まれたら利用開始です。

---

## C108 (次回開催) への移行ガイド

開催回が変更になった場合（例: C107 -> C108）、以下の手順でアプリを更新してください。

### 1. 地図画像の更新
`maps/` ディレクトリ内の地図画像を新しい開催回のものに差し替えます。
**軽量化のため、画像形式は WebP (.webp) を推奨します。**

### 2. 設定ファイルの更新 (`js/config.js`)
`js/config.js` を開き、以下の箇所を修正します。

#### a. 地図リンクのパス
ファイル名や拡張子を変更した場合、`MAP_LINKS` を更新してください。

```javascript
// 例: .jpg から .webp に変更した場合
MAP_LINKS: {
  東456: "./maps/C108Map_e456.webp",
  東7: "./maps/C108Map_e7.webp",
  西12: "./maps/C108Map_w12.webp",
  南12: "./maps/C108Map_s12.webp",
},
```

#### b. ブロック記号 (Label) の定義
コミケ毎にブロック記号（"A", "あ" 等）の割り当てが変わる場合があります。カタログ等を確認し、`LABEL_OPTIONS` を更新してください。

```javascript
LABEL_OPTIONS: {
    東456: "アイウ...".split(""), // 必要に応じて変更
    // ...
},
```

### 3. タイトルの更新 (`index.html`)
`<title>` タグやヘッダーの表示を開催回に合わせて更新してください。

---

## アプリの軽量化・最適化について

### 1. 画像の WebP 化（推奨）
地図画像をJPEG/PNGからWebP形式に変換することで、ファイルサイズを大幅に削減できます。

**変換手順例 (Mac/Linux):**
`cwebp` コマンド（WebPツール）を使用する場合：
```bash
# mapsディレクトリに移動
cd maps
# 全てのjpgをwebpに変換
for file in *.jpg; do cwebp "$file" -o "${file%.*}.webp"; done
```
変換後、`js/config.js` のパスを `.webp` に変更することを忘れないでください。

### 2. コードのミニファイ (Minification)
本番環境にデプロイする際、JavaScriptやCSSを圧縮（Minify）することで読み込み速度を向上させることができます。
- **ツール例**: Terser, Esbuild, UglifyJS
- ビルドツール（Vite, Webpack等）を導入すると自動化可能です。

### 3. PWA化 (Service Worker)
Service Workerを導入して地図画像やアセットをキャッシュすることで、オフライン時の動作をより確実にし、起動速度を向上させることができます。

---

## リファクタリング履歴 (2025/12)
- `UIManager` の機能を `ModalManager` (モーダル/ズーム), `StatsRenderer` (統計), `MapRenderer` (地図) に分割しました。
- 地図のピンチズーム機能を共通化し、メイン画面の地図にも適用しました。
